<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic AI Workflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
        }

        .neural-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stage-node {
            position: relative;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }

        .stage-node.pending {
            opacity: 0.4;
            transform: scale(0.9);
        }

        .stage-node.current {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.6);
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }

        .stage-node.completed {
            transform: scale(1);
            opacity: 1;
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.4); }
            100% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.8); }
        }

        .stage-connector {
            height: 3px;
            background: linear-gradient(90deg, #4f46e5, #7c3aed, #ec4899);
            position: relative;
            margin: 8px 0;
            border-radius: 2px;
            overflow: hidden;
        }

        .stage-connector.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            animation: flow 2s ease-in-out infinite;
        }

        @keyframes flow {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .reasoning-bubble {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .ai-thinking {
            background: linear-gradient(45deg, #1e293b, #334155);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .neural-pattern {
            background-image:
                    radial-gradient(circle at 25px 25px, rgba(99, 102, 241, 0.1) 2px, transparent 2px),
                    radial-gradient(circle at 75px 75px, rgba(99, 102, 241, 0.1) 2px, transparent 2px);
            background-size: 100px 100px;
        }

        .stage-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
        }

        .stage-icon.pending {
            background: rgba(107, 114, 128, 0.3);
            color: #9ca3af;
        }

        .stage-icon.current {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            color: white;
            animation: rotate 2s linear infinite;
        }

        .stage-icon.skipped {
            background: rgba(251, 146, 60, 0.3);
            color: #f59e0b;
        }

        .stage-node.skipped {
            opacity: 0.6;
            transform: scale(0.95);
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .thinking-dots::after {
            content: '';
            animation: thinking 1.5s ease-in-out infinite;
        }

        @keyframes thinking {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .neon-border {
            box-shadow:
                    0 0 5px rgba(99, 102, 241, 0.5),
                    0 0 10px rgba(99, 102, 241, 0.3),
                    0 0 15px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>
<body class="min-h-screen neural-pattern">
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent mb-2">
            üß† Agentic AI Workflow
        </h1>
        <p class="text-slate-300 text-lg">Intelligent SOAP Note Analysis & Validation</p>
        <div id="status-message" class="mt-4">
            <span id="ws-status" class="px-4 py-2 rounded-full text-sm font-semibold">Connecting...</span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-6">
            <div id="input-form" class="glassmorphism rounded-2xl p-6">
                <h2 class="text-xl font-semibold text-white mb-4">üìù Enter SOAP Note</h2>
                <textarea
                        id="soap-input"
                        rows="6"
                        class="w-full p-4 bg-slate-800/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-300"
                        placeholder="Enter your SOAP note here... e.g., Patient presents with internal hemorrhoids and the surgical plan is to use Milligan's technique for evaluation and management."
                ></textarea>
                <button
                        id="submit-button"
                        class="w-full mt-4 py-3 px-6 rounded-xl font-semibold transition duration-300 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed neon-border"
                        disabled
                >
                    üöÄ Analyze with AI
                </button>
            </div>

            <div id="ai-thinking" class="hidden glassmorphism rounded-2xl p-6">
                <div class="flex items-center mb-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center mr-3 animate-spin">
                        üß†
                    </div>
                    <h2 class="text-xl font-semibold text-white">AI Agent is Processing<span class="thinking-dots"></span></h2>
                </div>

                <div class="reasoning-bubble rounded-xl p-4 max-h-64 overflow-y-auto">
                    <div class="flex items-center mb-2">
                        <span class="text-purple-400 text-sm font-semibold">üí≠ Agent Thoughts</span>
                    </div>
                    <pre id="reasoning-trail" class="text-slate-300 text-sm whitespace-pre-wrap"></pre>
                </div>
            </div>

            <div id="question-form" class="hidden glassmorphism rounded-2xl p-6">
                <div class="flex items-center mb-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center mr-3">
                        ‚ùì
                    </div>
                    <h2 class="text-xl font-semibold text-white">Agent Needs More Information</h2>
                </div>
                <p id="question-text" class="text-slate-300 mb-4 p-4 bg-slate-800/30 rounded-lg border-l-4 border-orange-500"></p>
                <form id="responses-form" class="space-y-4"></form>
                <button
                        id="respond-button"
                        class="w-full mt-4 py-3 px-6 rounded-xl font-semibold transition duration-300 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white neon-border"
                >
                    üì§ Submit Response to Agent
                </button>
            </div>

            <div id="final-document" class="hidden glassmorphism rounded-2xl p-6">
                <div class="flex items-center mb-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center mr-3">
                        ‚úÖ
                    </div>
                    <h2 class="text-2xl font-bold text-white">Analysis Complete!</h2>
                </div>

                <div id="service-codes" class="mb-6"></div>

                <div class="reasoning-bubble rounded-xl p-4 max-h-96 overflow-y-auto">
                    <div class="flex items-center mb-2">
                        <span class="text-green-400 text-sm font-semibold">üìã Complete Reasoning Trail</span>
                    </div>
                    <pre id="final-reasoning-trail-content" class="text-slate-300 text-sm whitespace-pre-wrap"></pre>
                </div>

                <button
                        id="restart-button"
                        class="w-full mt-4 py-3 px-6 rounded-xl font-semibold transition duration-300 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white"
                >
                    üîÑ Start New Analysis
                </button>
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="glassmorphism rounded-2xl p-6 sticky top-8">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full flex items-center justify-center mr-3">
                        üîÑ
                    </div>
                    <h3 class="text-xl font-bold text-white">Workflow Pipeline</h3>
                </div>
                <div id="workflow-stages" class="space-y-3">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const soapInput = document.getElementById('soap-input');
        const submitButton = document.getElementById('submit-button');
        const wsStatus = document.getElementById('ws-status');
        const inputForm = document.getElementById('input-form');
        const aiThinking = document.getElementById('ai-thinking');
        const reasoningTrail = document.getElementById('reasoning-trail');
        const finalDocument = document.getElementById('final-document');
        const restartButton = document.getElementById('restart-button');
        const serviceCodesDiv = document.getElementById('service-codes');
        const finalReasoningTrailContent = document.getElementById('final-reasoning-trail-content');
        const questionForm = document.getElementById('question-form');
        const questionText = document.getElementById('question-text');
        const responsesForm = document.getElementById('responses-form');
        const respondButton = document.getElementById('respond-button');
        const workflowStages = document.getElementById('workflow-stages');

        // State
        let sessionId = null;
        let currentServiceCode = null;
        let ws = null;
        let allStages = [];
        const BACKEND_URL = "http://localhost:8000";

        // Stage Configuration - matches your LangGraph workflow
        const stageConfig = {
            'pii_detection': { name: 'PII Detection', icon: 'üîç', description: 'Scanning for sensitive information' },
            'anonymize_pii': { name: 'PII Anonymization', icon: 'üõ°Ô∏è', description: 'Protecting sensitive data' },
            'predict_service_codes': { name: 'Code Prediction', icon: 'üéØ', description: 'AI predicting service codes' },
            'rerank_service_codes': { name: 'Code Reranking', icon: 'üìä', description: 'Optimizing code selection' },
            'validate_soap': { name: 'SOAP Validation', icon: '‚úÖ', description: 'Validating against rules' },
            'question_generation': { name: 'Question Generation', icon: '‚ùì', description: 'Generating clarifying questions' },
            'output': { name: 'Final Output', icon: 'üìÑ', description: 'Preparing final results' }
        };

        function initializeWorkflowStages() {
            // Define all possible stages in the correct order
            const orderedStages = [
                'pii_detection',
                'anonymize_pii',
                'predict_service_codes',
                'rerank_service_codes',
                'validate_soap',
                'question_generation',
                'output'
            ];

            allStages = orderedStages.map(stageName => ({
                name: stageName,
                status: 'pending'
            }));

            renderWorkflowStages();
        }

        // New function to update stages based on the full state payload
        function updateStagesFromState(stagesInPayload) {
            if (!stagesInPayload || !Array.isArray(stagesInPayload)) return;

            const executedStages = stagesInPayload.map(s => s.code);
            const lastExecuted = stagesInPayload[stagesInPayload.length - 1]?.code;

            console.log('Executed Stages in Payload:', executedStages);
            console.log('Last Executed Stage:', lastExecuted);

            // First, update all stages based on the payload
            allStages.forEach(stage => {
                const stageWasInPayload = executedStages.includes(stage.name);

                if (stageWasInPayload) {
                    // This stage has been executed
                    if (stage.name === lastExecuted) {
                        stage.status = 'current';
                    } else {
                        stage.status = 'completed';
                    }
                } else {
                    // Check if it was skipped
                    const lastExecutedIndex = allStages.findIndex(s => s.name === lastExecuted);
                    const stageIndex = allStages.findIndex(s => s.name === stage.name);
                    const isSkipped = lastExecutedIndex > -1 && stageIndex < lastExecutedIndex;

                    if (isSkipped && stage.status !== 'completed' && stage.status !== 'skipped') {
                        // Mark as skipped if it's before the last executed stage but not in payload
                        stage.status = 'skipped';
                    } else if (stage.status !== 'skipped' && stage.status !== 'completed') {
                        // Otherwise, it's still pending
                        stage.status = 'pending';
                    }
                }
            });

            // Re-render the UI
            renderWorkflowStages();
        }

        function renderWorkflowStages() {
            workflowStages.innerHTML = '';

            allStages.forEach((stage, index) => {
                const config = stageConfig[stage.name];
                if (!config) return;

                const stageDiv = document.createElement('div');
                stageDiv.className = `stage-node ${stage.status}`;

                stageDiv.innerHTML = `
                        <div class="flex items-center space-x-3 p-3 rounded-lg ${getStageBackgroundClass(stage.status)}">
                            <div class="stage-icon ${stage.status}">
                                ${config.icon}
                            </div>
                            <div class="flex-1">
                                <div class="text-white font-semibold text-sm">${config.name}</div>
                                <div class="text-slate-400 text-xs">${config.description}</div>
                            </div>
                            <div class="stage-status">
                                ${getStatusIndicator(stage.status)}
                            </div>
                        </div>
                    `;

                workflowStages.appendChild(stageDiv);

                // Add connector between stages (except for the last one)
                if (index < allStages.length - 1) {
                    const connector = document.createElement('div');
                    connector.className = `stage-connector ${allStages[index + 1].status === 'pending' || allStages[index + 1].status === 'skipped' ? '' : 'active'}`;
                    workflowStages.appendChild(connector);
                }
            });
        }

        function getStageBackgroundClass(status) {
            switch (status) {
                case 'current': return 'bg-gradient-to-r from-purple-600/30 to-blue-600/30 border border-purple-500/50';
                case 'completed': return 'bg-gradient-to-r from-green-600/20 to-emerald-600/20 border border-green-500/30';
                case 'skipped': return 'bg-gradient-to-r from-orange-600/20 to-yellow-600/20 border border-orange-500/30';
                default: return 'bg-slate-800/30 border border-slate-600/30';
            }
        }

        function getStatusIndicator(status) {
            switch (status) {
                case 'current': return '<div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse"></div>';
                case 'completed': return '<div class="w-3 h-3 bg-green-500 rounded-full"></div>';
                case 'skipped': return '<div class="w-3 h-3 bg-orange-500 rounded-full"></div>';
                default: return '<div class="w-3 h-3 bg-gray-500 rounded-full opacity-30"></div>';
            }
        }

        function updateReasoningTrail(trail) {
            if (!Array.isArray(trail)) return;

            reasoningTrail.innerHTML = '';
            trail.slice(-10).forEach((line, idx, arr) => {
                const span = document.createElement('span');
                span.textContent = line + '\n';
                span.className = 'text-slate-400';
                reasoningTrail.appendChild(span);
            });

            // Auto-scroll to bottom
            reasoningTrail.parentElement.scrollTop = reasoningTrail.parentElement.scrollHeight;
        }

        function connectWebSocket() {
            wsStatus.textContent = "Connecting to AI...";
            wsStatus.className = "text-yellow-400 bg-yellow-400/10 border border-yellow-400/30";

            sessionId = localStorage.getItem('sessionId') || crypto.randomUUID();
            localStorage.setItem('sessionId', sessionId);
            ws = new WebSocket(`ws://localhost:8000/ws/agentic-workflow/${sessionId}`);

            ws.onopen = () => {
                wsStatus.textContent = "ü§ñ AI Connected";
                wsStatus.className = "text-green-400 bg-green-400/10 border border-green-400/30";
                submitButton.disabled = false;
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    const payload = data.payload || {};

                    console.log('Received WebSocket message:', data);

                    // Always update reasoning trail and stages from the full payload
                    if (payload.reasoning_trail) {
                        updateReasoningTrail(payload.reasoning_trail);
                    }
                    if (payload.stages) {
                        updateStagesFromState(payload.stages);
                    }

                    // Handle specific event types
                    switch (data.event_type) {
                        case 'waiting_for_user':
                            handleWaitingForUser(payload);
                            break;
                        case 'workflow_finished':
                            handleWorkflowFinished(payload);
                            break;
                    }
                } catch (e) {
                    console.error("Failed to parse WebSocket message:", e);
                }
            };

            ws.onclose = () => {
                wsStatus.textContent = "‚ùå Disconnected";
                wsStatus.className = "text-red-400 bg-red-400/10 border border-red-400/30";
                submitButton.disabled = true;
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
                wsStatus.textContent = "‚ö†Ô∏è Connection Error";
                wsStatus.className = "text-red-400 bg-red-400/10 border border-red-400/30";
            };
        }

        function handleWaitingForUser(payload) {
            // Hide AI thinking, show question form
            aiThinking.classList.add('hidden');
            questionForm.classList.remove('hidden');

            questionText.textContent = payload.question || "Please provide additional information.";

            const match = payload.predicted_service_codes?.[0]?.code;
            currentServiceCode = match || null;

            // Generate input fields
            responsesForm.innerHTML = '';
            if (payload.predicted_service_codes?.[0]?.missing_terms) {
                payload.predicted_service_codes[0].missing_terms.forEach(termObj => {
                    if (!termObj.answered) {
                        const term = termObj.term;
                        const termId = term.replace(/\s+/g, '-').toLowerCase();
                        const div = document.createElement('div');
                        div.className = "space-y-2";
                        div.innerHTML = `
                            <label for="${termId}" class="block text-sm font-medium text-slate-300">${term}</label>
                            <textarea
                                id="${termId}"
                                name="${term}"
                                rows="2"
                                class="w-full p-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition duration-300"
                                placeholder="Enter ${term.toLowerCase()}..."
                            ></textarea>
                        `;
                        responsesForm.appendChild(div);
                    }
                });
            }
        }

        function handleWorkflowFinished(payload) {
            // Hide all processing forms, show final results
            inputForm.classList.add('hidden');
            aiThinking.classList.add('hidden');
            questionForm.classList.add('hidden');
            finalDocument.classList.remove('hidden');

            // Display service codes
            if (payload.predicted_service_codes) {
                const html = payload.predicted_service_codes.map(code => {
                    const severityColor = code.severity === 'fail' ? 'from-red-500 to-red-600' : 'from-green-500 to-green-600';
                    const severityLabel = code.severity === 'fail' ? '‚ùå Validation Failed' : '‚úÖ Validation Passed';
                    const missingTerms = code.missing_terms?.map(term =>
                        `<div class="flex justify-between items-center py-1">
                                <span>${term.term}</span>
                                <span class="${term.answered ? 'text-green-400' : 'text-red-400'}">${term.answered ? '‚úì' : '‚úó'}</span>
                            </div>`
                    ).join('') || '';
                    const suggestions = code.suggestions?.map(s => `<li class="text-slate-300">${s}</li>`).join('') || '';

                    return `
                            <div class="glassmorphism rounded-xl p-4 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-xl font-bold text-white">Service Code: ${code.code}</h3>
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold bg-gradient-to-r ${severityColor} text-white">
                                        ${severityLabel}
                                    </span>
                                </div>
                                ${missingTerms ? `
                                    <div class="mb-3">
                                        <h4 class="text-sm font-semibold text-slate-300 mb-2">Missing Terms:</h4>
                                        <div class="bg-slate-800/50 rounded-lg p-3 space-y-1">
                                            ${missingTerms}
                                        </div>
                                    </div>
                                ` : ''}
                                ${suggestions ? `
                                    <div>
                                        <h4 class="text-sm font-semibold text-slate-300 mb-2">Suggestions:</h4>
                                        <ul class="list-disc list-inside text-sm space-y-1">${suggestions}</ul>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                }).join('');
                serviceCodesDiv.innerHTML = html;
            }

            // Display full reasoning trail
            if (payload.reasoning_trail) {
                finalReasoningTrailContent.textContent = payload.reasoning_trail.join('\n');
            }
        }

        // Event Listeners
        submitButton.addEventListener('click', async () => {
            const soapText = soapInput.value.trim();
            if (!soapText) {
                alert('Please enter a SOAP note.');
                return;
            }

            // Initialize stages and show AI thinking
            initializeWorkflowStages();
            inputForm.classList.add('hidden');
            aiThinking.classList.remove('hidden');
            reasoningTrail.textContent = 'AI Agent initializing...\n';

            try {
                const response = await fetch(`${BACKEND_URL}/api/submit_soap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ soap_text: soapText, session_id: sessionId })
                });

                if (!response.ok) {
                    const result = await response.json();
                    reasoningTrail.textContent = `Error: ${result.detail}`;
                }
            } catch (error) {
                reasoningTrail.textContent = `Connection Error: ${error.message}`;
            }
        });

        respondButton.addEventListener('click', async () => {
            const userResponses = {};
            let allFilled = true;

            responsesForm.querySelectorAll('textarea').forEach(input => {
                if (!input.value.trim()) {
                    allFilled = false;
                }
                userResponses[input.name] = input.value.trim();
            });

            if (!allFilled) {
                alert('Please fill in all required fields.');
                return;
            }

            // Switch back to AI thinking
            questionForm.classList.add('hidden');
            aiThinking.classList.remove('hidden');

            try {
                const response = await fetch(`${BACKEND_URL}/api/respond?session_id=${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        responses: [{
                            service_code: currentServiceCode,
                            answers: userResponses
                        }]
                    })
                });

                if (!response.ok) {
                    const result = await response.json();
                    reasoningTrail.textContent = `Error: ${result.detail}`;
                }
            } catch (error) {
                reasoningTrail.textContent = `Connection Error: ${error.message}`;
            }
        });

        restartButton.addEventListener('click', () => {
            // Reset UI
            inputForm.classList.remove('hidden');
            finalDocument.classList.add('hidden');
            aiThinking.classList.add('hidden');
            questionForm.classList.add('hidden');

            // Clear form
            soapInput.value = '';

            // Clear service codes and reasoning trail
            serviceCodesDiv.innerHTML = '';
            finalReasoningTrailContent.textContent = '';

            // Generate new session
            sessionId = crypto.randomUUID();
            localStorage.setItem('sessionId', sessionId);

            // Reset stages
            initializeWorkflowStages();

            // Reconnect WebSocket
            if (ws) ws.close();
            connectWebSocket();
        });

        // Initialize
        initializeWorkflowStages();
        connectWebSocket();
    });
</script>
</body>
</html>
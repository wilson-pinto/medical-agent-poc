<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agentic Healthcare AI Workflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stage-node { transition: all .4s cubic-bezier(.4,0,.2,1); }
    </style>
</head>
<body class="bg-[#0f0f23] text-white antialiased">

<div class="container mx-auto p-6">
    <h1 class="text-4xl font-bold text-center mb-6 bg-gradient-to-r from-cyan-400 to-purple-500 bg-clip-text text-transparent">
        Agentic Healthcare AI
    </h1>
    <div class="flex gap-8">
        <!-- LEFT -->
        <div class="flex-1 space-y-6">
            <div id="input-form" class="bg-white/5 p-6 rounded-xl">
                <h2 class="font-semibold mb-2">📝 Enter SOAP Note</h2>
                <textarea id="soap-input" rows="6" class="w-full p-3 bg-slate-900 border border-slate-800 rounded text-sm"
                          placeholder="Enter SOAP note here..."></textarea>
                <button id="submit-button" disabled class="w-full mt-3 p-3 rounded bg-gradient-to-r from-purple-600 to-blue-600 hover:opacity-90">
                    Analyse
                </button>
            </div>
            <div id="ai-thinking" class="hidden p-6 bg-white/5 rounded-xl">
                <p>🤖 Processing...</p>
                <pre id="reasoning-trail" class="text-xs whitespace-pre-wrap"></pre>
            </div>
            <div id="question-form" class="hidden p-6 bg-white/5 rounded-xl space-y-2">
                <p id="question-text" class="font-medium"></p>
                <form id="responses-form"></form>
                <button id="respond-button" class="w-full p-2 bg-orange-500 rounded">Submit</button>
            </div>
            <div id="final-document" class="hidden p-6 bg-white/5 rounded-xl">
                <h3 class="font-bold text-lg mb-2">✅ Complete</h3>
                <div id="service-codes"></div>
                <pre id="final-reasoning-trail-content" class="text-xs whitespace-pre-wrap mt-4"></pre>
                <button id="restart-button" class="mt-4 p-2 rounded bg-slate-700">Start New</button>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="w-[320px] max-h-[calc(100vh-4rem)] overflow-y-auto">
            <div class="bg-white/5 p-4 rounded-xl space-y-3">
                <h3 class="font-semibold mb-2">📊 Workflow Timeline</h3>
                <div id="workflow-stages" class="space-y-4 text-xs"></div>
            </div>
        </div>
    </div>
</div>

<!--<script>-->
<!--    document.addEventListener('DOMContentLoaded', () => {-->
<!--        const soapInput     = document.getElementById('soap-input');-->
<!--        const submitButton  = document.getElementById('submit-button');-->
<!--        const inputForm     = document.getElementById('input-form');-->
<!--        const aiThinking    = document.getElementById('ai-thinking');-->
<!--        const reasoningTrail= document.getElementById('reasoning-trail');-->
<!--        const questionForm  = document.getElementById('question-form');-->
<!--        const questionText  = document.getElementById('question-text');-->
<!--        const responsesForm = document.getElementById('responses-form');-->
<!--        const respondButton = document.getElementById('respond-button');-->
<!--        const finalDocument = document.getElementById('final-document');-->
<!--        const serviceCodesDiv = document.getElementById('service-codes');-->
<!--        const finalReasoningTrailContent = document.getElementById('final-reasoning-trail-content');-->
<!--        const restartButton = document.getElementById('restart-button');-->
<!--        const workflowStages= document.getElementById('workflow-stages');-->

<!--        const BACKEND_URL   = "http://localhost:8000";-->

<!--        let sessionId = null;-->
<!--        let ws        = null;-->
<!--        let allStages = [];-->
<!--        let currentServiceCode = null;-->

<!--        const stageConfig = {-->
<!--            'pii_detection':        { name: 'PII Detection',        icon: '🔍'},-->
<!--            'anonymize_pii':        { name: 'Anonymization',        icon: '🛡️'},-->
<!--            'predict_service_codes':{ name: 'Prediction',           icon: '🎯'},-->
<!--            'rerank_service_codes': { name: 'Rerank',               icon: '📊'},-->
<!--            'validate_soap':        { name: 'Validation',           icon: '✅'},-->
<!--            'check_referral_required': { name: 'Check Referral',    icon: '🏥'},-->
<!--            'execute_referral':     { name: 'Referral',             icon: '📨'},-->
<!--            'question_generation':  { name: 'Clarifications',       icon: '❓'},-->
<!--            'output':               { name: 'Output',               icon: '📄'},-->
<!--            'patient_summary':      { name: 'Summary',              icon: '🧾'},-->
<!--            'patient_summary_pdf':  { name: 'PDF',                  icon: '📥'},-->
<!--            'execute_gmail_draft':  { name: 'Email Draft',          icon: '✉️'}-->
<!--        };-->
<!--        const stageOrder = Object.keys(stageConfig);-->

<!--        // Render timeline-->
<!--        function renderStages(){-->
<!--            workflowStages.innerHTML = '';-->
<!--            if(!allStages.length){-->
<!--                workflowStages.innerHTML = '<div class="text-slate-500 text-center py-6">Waiting...</div>';-->
<!--                return;-->
<!--            }-->
<!--            allStages.forEach((s, idx)=>{-->
<!--                const cfg = stageConfig[s.name];-->
<!--                const node = document.createElement('div');-->
<!--                node.className = 'stage-node flex space-x-2 p-2 rounded ' + (s.status==='completed'?'bg-green-600/20':s.status==='current'?'bg-purple-600/20':'bg-slate-700/20');-->
<!--                node.innerHTML = `<span>${cfg.icon}</span><div class="flex-1 text-xs">${cfg.name}</div><span>${s.status==='current'?'⏳':s.status==='completed'?'✅':''}</span>`;-->
<!--                workflowStages.appendChild(node);-->
<!--                if(idx < allStages.length-1){-->
<!--                    const bar = document.createElement('div');-->
<!--                    bar.className='h-[3px] rounded-full my-1 '+ (allStages[idx+1].status!=='pending'?'bg-gradient-to-r from-purple-600 to-blue-600':'bg-slate-700/40');-->
<!--                    workflowStages.appendChild(bar);-->
<!--                }-->
<!--            });-->
<!--        }-->

<!--        // Update stage timeline-->
<!--        function updateStagesFromState(stageArr){-->
<!--            const executed = stageArr.map(x=>x.code);-->
<!--            const last = executed[executed.length-1];-->
<!--            stageArr.forEach(s=>{-->
<!--                if(!allStages.some(x=>x.name===s.code)){-->
<!--                    const idx = stageOrder.indexOf(s.code);-->
<!--                    allStages.splice(idx,0,{name:s.code, status:'pending'});-->
<!--                }-->
<!--            });-->
<!--            allStages.forEach(n=>{-->
<!--                n.status = executed.includes(n.name) ? (n.name===last?'current':'completed') : 'pending';-->
<!--            });-->
<!--            renderStages();-->
<!--        }-->

<!--        function updateReasoningTrail(trl){-->
<!--            reasoningTrail.textContent = trl.slice(-10).join("\n");-->
<!--            reasoningTrail.scrollTop = reasoningTrail.scrollHeight;-->
<!--        }-->

<!--        function connectWebSocket(){-->
<!--            sessionId = crypto.randomUUID();-->
<!--            ws = new WebSocket(`ws://localhost:8000/ws/agentic-workflow/${sessionId}`);-->
<!--            ws.onopen = ()=> submitButton.disabled = false;-->

<!--            ws.onmessage = (e)=>{-->
<!--                const msg = JSON.parse(e.data);-->
<!--                const p   = msg.payload || {};-->
<!--                if(p.stages) updateStagesFromState(p.stages);-->
<!--                if(p.reasoning_trail) updateReasoningTrail(p.reasoning_trail);-->

<!--                if(msg.event_type==='waiting_for_user') showQuestionForm(p);-->
<!--                if(msg.event_type==='pdf_ready') downloadPDF(p.filename,p.pdf_base64);-->
<!--                if(msg.event_type==='gmail_draft_created') alert('Gmail draft created');-->
<!--                if(msg.event_type==='workflow_finished') showFinal(p);-->
<!--            };-->
<!--        }-->

<!--        function showQuestionForm(payload){-->
<!--            aiThinking.classList.add('hidden');-->
<!--            questionForm.classList.remove('hidden');-->
<!--            currentServiceCode = payload.predicted_service_codes?.[0]?.code || null;-->
<!--            questionText.textContent = payload.question || '';-->
<!--            responsesForm.innerHTML='';-->
<!--            (payload.predicted_service_codes?.[0]?.missing_terms||[]).forEach(m=>{-->
<!--                if(!m.answered){-->
<!--                    const id = m.term.toLowerCase().replace(/\s+/g,'-');-->
<!--                    responsesForm.insertAdjacentHTML('beforeend',`-->
<!--                    <label class="block mt-2">${m.term}</label>-->
<!--                    <textarea id="${id}" name="${m.term}" class="w-full p-2 bg-slate-800 rounded"></textarea>-->
<!--                `);-->
<!--                }-->
<!--            });-->
<!--        }-->

<!--        function showFinal(payload){-->
<!--            aiThinking.classList.add('hidden');-->
<!--            questionForm.classList.add('hidden');-->
<!--            finalDocument.classList.remove('hidden');-->
<!--            serviceCodesDiv.innerHTML = payload.predicted_service_codes.map(c=>`-->
<!--            <div class="p-4 bg-slate-800 rounded mb-2">-->
<!--                <div class="flex justify-between"><strong>${c.code}</strong><span>${c.severity==='pass'?'✅':'❌'}</span></div>-->
<!--            </div>-->
<!--        `).join('');-->
<!--            finalReasoningTrailContent.textContent = payload.reasoning_trail.join('\n');-->
<!--            renderStages();-->
<!--        }-->

<!--        submitButton.onclick = async()=>{-->
<!--            const text = soapInput.value.trim();-->
<!--            if(!text) return;-->
<!--            inputForm.classList.add('hidden');-->
<!--            aiThinking.classList.remove('hidden');-->
<!--            allStages=[]; renderStages();-->
<!--            await fetch(`${BACKEND_URL}/api/submit_soap`,{-->
<!--                method:'POST', headers:{'Content-Type':'application/json'},-->
<!--                body:JSON.stringify({soap_text:text,session_id:sessionId})-->
<!--            });-->
<!--        };-->

<!--        respondButton.onclick= async()=>{-->
<!--            const answers={};-->
<!--            let ok=true;-->
<!--            responsesForm.querySelectorAll('textarea').forEach(t=>{-->
<!--                if(!t.value.trim()) ok=false;-->
<!--                answers[t.name]=t.value.trim();-->
<!--            });-->
<!--            if(!ok) return alert('Please fill all');-->
<!--            aiThinking.classList.remove('hidden');-->
<!--            questionForm.classList.add('hidden');-->
<!--            await fetch(`${BACKEND_URL}/api/respond?session_id=${sessionId}`,{-->
<!--                method:'POST', headers:{'Content-Type':'application/json'},-->
<!--                body:JSON.stringify({responses:[{service_code:currentServiceCode,answers}]})-->
<!--            });-->
<!--        };-->

<!--        restartButton.onclick=()=>location.reload();-->

<!--        connectWebSocket();-->
<!--    });-->
<!--</script>-->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const soapInput = document.getElementById('soap-input');
        const submitButton = document.getElementById('submit-button');
        const inputForm = document.getElementById('input-form');
        const aiThinking = document.getElementById('ai-thinking');
        const reasoningTrail = document.getElementById('reasoning-trail');
        const questionForm = document.getElementById('question-form');
        const questionText = document.getElementById('question-text');
        const responsesForm = document.getElementById('responses-form');
        const respondButton = document.getElementById('respond-button');
        const finalDocument = document.getElementById('final-document');
        const restartButton = document.getElementById('restart-button');
        const workflowStages = document.getElementById('workflow-stages');

        let sessionId = null, currentServiceCode = null, ws = null;
        let allStages = [];

        const BACKEND_URL = "http://localhost:8000";

        const stageConfig = {
            'pii_detection': { name:'PII Detection', icon:'🔍', description:'Scanning for sensitive data' },
            'anonymize_pii': { name:'Anonymization', icon:'🛡️', description:'Masking sensitive info'},
            'predict_service_codes': { name:'Prediction', icon:'🎯', description:'Predicting codes'},
            'rerank_service_codes': { name:'Rerank', icon:'📊', description:'Selecting best code'},
            'validate_soap': { name:'Validation', icon:'✅', description:'Checking compliance'},
            'check_referral_required': { name:'Check Referral', icon:'🏥', description:'Does referral needed?'},
            'execute_referral': { name:'Referral', icon:'📨', description:'Trigger referral logic'},
            'question_generation': { name:'Clarifications', icon:'❓', description:'Need more details'},
            'output': { name:'Output', icon:'📄', description:'Finalizing'},
            'patient_summary': { name:'Summary', icon:'🧾', description:'Patient summary'},
            'patient_summary_pdf': { name:'PDF', icon:'📥', description:'Generating PDF'},
            'execute_gmail_draft': { name:'Email Draft', icon:'✉️', description:'Saving draft'}
        };
        const stageOrder = Object.keys(stageConfig);

        function initializeWorkflowStages(){
            allStages = [];
            workflowStages.innerHTML = '';
        }

        function updateStagesFromState(stages){
            if(!stages) return;
            const executed = stages.map(s=>s.code);
            const last = executed.at(-1);
            stages.forEach(p=>{
                if(!allStages.some(x=>x.name===p.code)){
                    allStages.splice(stageOrder.indexOf(p.code),0,{name:p.code,status:'pending'});
                }
            });
            allStages.forEach(s=>{
                s.status = executed.includes(s.name) ?
                    (s.name===last?'current':'completed') : 'pending';
            });
            renderStages();
        }

        function renderStages(){
            workflowStages.innerHTML='';
            if(!allStages.length){
                workflowStages.innerHTML='<div class="py-6 text-center text-slate-500">Waiting...</div>';
                return;
            }
            allStages.forEach((s,i)=>{
                const c = stageConfig[s.name];
                const div = document.createElement('div');
                div.innerHTML = `
            <div class="flex space-x-3 p-3 rounded ${s.status==='current'?'bg-purple-600/20':
                    s.status==='completed'?'bg-green-600/20':'bg-slate-700/20'}">
                <span>${c.icon}</span>
                <div class="flex-1">
                    <div class="text-sm font-bold">${c.name}</div>
                    <div class="text-[11px] text-slate-400">${c.description}</div>
                </div>
                <div>${s.status==='current'?'⏳':s.status==='completed'?'✅':''}</div>
            </div>`;
                workflowStages.appendChild(div);

                if(i<allStages.length-1){
                    const line=document.createElement('div');
                    line.className=`h-2 rounded-full my-1 ${allStages[i+1].status!=='pending'
                        ?'bg-gradient-to-r from-purple-600 to-blue-600':'bg-slate-600/40'}`;
                    workflowStages.appendChild(line);
                }
            });
        }

        function updateReasoningTrail(trail){ reasoningTrail.textContent = trail.slice(-10).join('\n'); }

        function connectWS(){
            sessionId = crypto.randomUUID();
            ws = new WebSocket(`ws://localhost:8000/ws/agentic-workflow/${sessionId}`);
            ws.onopen = () => submitButton.disabled = false;

            ws.onmessage = (e)=>{
                const m = JSON.parse(e.data), p = m.payload||{};
                if(p.stages) updateStagesFromState(p.stages);
                if(p.reasoning_trail) updateReasoningTrail(p.reasoning_trail);

                if(m.event_type==='waiting_for_user') handleWaitingForUser(p);
                if(m.event_type==='workflow_finished') handleWorkflowFinished(p);
                if(m.event_type==='gmail_draft_created') alert('Gmail draft created!');
            };
        }

        function downloadPDF(){
            window.open(`${BACKEND_URL}/api/download_pdf/${sessionId}`, '_blank');
        }

        function handleWaitingForUser(p){
            aiThinking.classList.add('hidden');
            questionForm.classList.remove('hidden');
            currentServiceCode = p.predicted_service_codes?.[0]?.code || null;
            questionText.textContent = p.question || 'Please supply information:';
            responsesForm.innerHTML = '';
            (p.predicted_service_codes?.[0]?.missing_terms || []).forEach(mt=>{
                const id = mt.term.toLowerCase().replace(/\s/g,'-');
                responsesForm.innerHTML += `
            <label for="${id}" class="block text-sm mt-2">${mt.term}</label>
            <textarea id="${id}" name="${mt.term}" class="w-full p-2 rounded bg-slate-800"></textarea>`;
            });
        }

        function handleWorkflowFinished(p){
            aiThinking.classList.add('hidden');
            questionForm.classList.add('hidden');
            finalDocument.classList.remove('hidden');

            finalDocument.innerHTML = `
        <div class="flex border-b mb-4">
            <button id="tab-patient" class="px-3 py-2 border-b-2 border-blue-500 text-blue-300">Patient Summary</button>
            <button id="tab-clinical" class="px-3 py-2 text-slate-400">Clinical Details</button>
        </div>
        <div id="view-patient"></div>
        <div id="view-clinical" class="hidden"></div>`;

            const patientView=document.getElementById('view-patient');
            patientView.innerHTML = `
        <p class="mb-4 whitespace-pre-line">${p.patient_summary || 'No summary available.'}</p>
        <button id="dlpdf" class="bg-blue-600 px-3 py-2 rounded mr-2 text-sm">📄 Download PDF</button>
        <button id="emaildraft" class="bg-green-700 px-3 py-2 rounded text-sm">✉️ Create Gmail Draft</button>`;

            document.getElementById('dlpdf').onclick = downloadPDF;
            document.getElementById('emaildraft').onclick = () => {
                fetch(`${BACKEND_URL}/api/generate_gmail?session=${sessionId}`);
            };

            const clinical=document.getElementById('view-clinical');
            clinical.innerHTML = (p.predicted_service_codes || []).map(c=>`
        <div class="p-3 mb-3 rounded bg-slate-700">
            <div class="font-semibold">${c.code} (${c.severity})</div>
            <div class="text-xs">${(c.suggestions||[]).join(' ')}</div>
        </div>`).join('') +
                `<pre class="text-[11px] mt-4">${(p.reasoning_trail||[]).join('\n')}</pre>`;

            document.getElementById('tab-patient').onclick = ()=>switchTab(true);
            document.getElementById('tab-clinical').onclick = ()=>switchTab(false);
            renderStages();
        }

        function switchTab(pt){
            document.getElementById('view-patient').classList.toggle('hidden', !pt);
            document.getElementById('view-clinical').classList.toggle('hidden', pt);
            document.getElementById('tab-patient').classList.toggle('border-blue-500', pt);
            document.getElementById('tab-clinical').classList.toggle('border-blue-500', !pt);
        }

        submitButton.onclick = async ()=>{
            const txt = soapInput.value.trim();
            if(!txt) return;
            inputForm.classList.add('hidden');
            aiThinking.classList.remove('hidden');
            initializeWorkflowStages();
            await fetch(`${BACKEND_URL}/api/submit_soap`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({soap_text: txt, session_id: sessionId})
            });
        };

        respondButton.onclick = async ()=>{
            const answers={}, areas=responsesForm.querySelectorAll('textarea');
            for(let t of areas){
                if(!t.value.trim()) return alert('Please fill all');
                answers[t.name] = t.value.trim();
            }
            questionForm.classList.add('hidden');
            aiThinking.classList.remove('hidden');
            await fetch(`${BACKEND_URL}/api/respond?session_id=${sessionId}`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({responses:[{service_code: currentServiceCode, answers}]})
            });
        };

        restartButton.onclick = ()=>location.reload();

        connectWS();
    });
</script>


</body>
</html>
